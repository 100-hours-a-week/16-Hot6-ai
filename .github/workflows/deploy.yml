name: AI CI & Dev CD

on:
  push:
    branches:
      - main
      - dev
      - feat/dev-cd

jobs:
  package-fastapi:
    name: Package FastAPI Application
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'main' || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Package FastAPI application
        run: |
          mkdir -p artifact
          cp -r app artifact/
          cp -r alembic artifact/
          cp requirements.txt artifact/

      - name: Upload FastAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastapi-server
          path: artifact/

  deploy-dev:
    name: Deploy to Dev via SSH
    needs: package-fastapi
    if: ${{ github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/feat/dev-cd' }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'main' || 'dev' }}

    steps:
      - name: Download FastAPI artifact
        uses: actions/download-artifact@v4
        with:
          name: fastapi-server
          path: ./fastapi

      - name: Set up SSH config for jump server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.JUMP_SSH_KEY }}" > ~/.ssh/jump_key
          chmod 600 ~/.ssh/jump_key

          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/dev_key
          chmod 600 ~/.ssh/dev_key

          cat <<EOF > ~/.ssh/config
          Host ai-dev-server
              HostName ${{ secrets.SSH_HOST }}
              User ubuntu
              IdentityFile ~/.ssh/dev_key
              ProxyJump jump-server
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null

          Host jump-server
              HostName ${{ secrets.JUMP_SSH_HOST }}
              User ubuntu
              IdentityFile ~/.ssh/jump_key
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
          EOF

      - name: Copy FastAPI files to dev server
        run: |
          ssh -F ~/.ssh/config ai-dev-server 'rm -rf ~/ai-server && mkdir -p ~/ai-server'
          scp -r -F ~/.ssh/config fastapi/* ai-dev-server:/home/ubuntu/ai-server/

      - name: Restart AI server via jump server
        run: |
          ssh -F ~/.ssh/config ai-dev-server <<'EOF'
            set -eux
            cd ~/ai-server
            pkill -f "uvicorn" || true
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > ai.log 2>&1 &
          EOF
